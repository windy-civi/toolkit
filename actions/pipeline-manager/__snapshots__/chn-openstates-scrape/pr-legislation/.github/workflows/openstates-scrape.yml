name: OpenStates Scrape for pr

on:
  schedule:
    - cron: "0 8 * * *" # Daily at 8:00 AM UTC (2:00 AM Chicago time)
  workflow_dispatch:
    inputs:
      force-update:
        type: boolean
        description: "Force push even if upstream changed (use with caution)"
        default: false

env:
  STATE_CODE: pr
  FILES_REPO: chn-openstates-files/pr-legislation

jobs:
  scrape:
    name: "üï∑Ô∏è Scrape Data"
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout state repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run scraper action
        id: scrape
        uses: windy-civi/toolkit/actions/scrape@main
        with:
          state: ${{ env.STATE_CODE }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-and-push: true
          force-update: ${{ inputs.force-update }}
          branch: main
          api-keys: |
            {
              "DC_API_KEY": "${{ secrets.DC_API_KEY }}",
              "NEW_YORK_API_KEY": "${{ secrets.NEW_YORK_API_KEY }}",
              "INDIANA_API_KEY": "${{ secrets.INDIANA_API_KEY }}",
              "USER_AGENT": "${{ secrets.USER_AGENT }}"
            }

      - name: Trigger files repo to format data
        if: success()
        run: |
          echo "üöÄ Triggering format workflow in ${{ env.FILES_REPO }}..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DISPATCH_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ env.FILES_REPO }}/dispatches \
            -d '{"event_type":"scrape-and-format-complete","client_payload":{"state":"${{ env.STATE_CODE }}","triggered_by":"${{ github.repository }}"}}'
          echo "‚úÖ Triggered format workflow"
