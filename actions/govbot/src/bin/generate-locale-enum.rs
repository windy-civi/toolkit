//! Generate a Rust enum from working locales in pipeline-manager config.yml
//! Run with: cargo run --bin generate-locale-enum

use serde::Deserialize;
use std::collections::HashMap;
use std::fs;
use std::path::PathBuf;

#[derive(Debug, Deserialize)]
struct Config {
    locales: HashMap<String, LocaleConfig>,
}

#[derive(Debug, Deserialize)]
struct LocaleConfig {
    #[allow(dead_code)]
    template: String,
    #[serde(default)]
    labels: Vec<String>,
}

fn locale_to_variant(locale: &str) -> String {
    // Two-letter codes should be uppercase (e.g., 'ar' -> 'AR', 'pr' -> 'PR')
    // Longer codes should be capitalized (e.g., 'usa' -> 'Usa')
    if locale.len() <= 2 {
        locale.to_uppercase()
    } else {
        let mut chars = locale.chars();
        match chars.next() {
            None => String::new(),
            Some(first) => first.to_uppercase().collect::<String>() + chars.as_str(),
        }
    }
}

fn get_working_locales(config_path: &PathBuf) -> Result<Vec<String>, Box<dyn std::error::Error>> {
    let content = fs::read_to_string(config_path)?;
    let config: Config = serde_yaml::from_str(&content)?;

    let mut working_locales: Vec<String> = config
        .locales
        .into_iter()
        .filter(|(_, locale_config)| locale_config.labels.contains(&"working".to_string()))
        .map(|(locale, _)| locale)
        .collect();

    working_locales.sort();
    Ok(working_locales)
}

fn generate_rust_enum(
    locales: &[String],
    output_path: &PathBuf,
) -> Result<(), Box<dyn std::error::Error>> {
    // Create mapping of locale -> variant name
    let locale_variants: Vec<(String, String)> = locales
        .iter()
        .map(|loc| (loc.clone(), locale_to_variant(loc)))
        .collect();

    // Generate enum variants
    let enum_variants: Vec<String> = locale_variants
        .iter()
        .map(|(_, variant)| format!("    {},", variant))
        .collect();

    // Generate match arms for as_str
    let as_str_arms: Vec<String> = locale_variants
        .iter()
        .map(|(locale, variant)| {
            format!("            WorkingLocale::{} => \"{}\",", variant, locale)
        })
        .collect();

    // Generate match arms for as_lowercase
    let as_lowercase_arms: Vec<String> = locale_variants
        .iter()
        .map(|(locale, variant)| {
            format!(
                "            WorkingLocale::{} => \"{}\",",
                variant,
                locale.to_lowercase()
            )
        })
        .collect();

    // Generate match arms for From<&str>
    let from_str_arms: Vec<String> = locale_variants
        .iter()
        .map(|(locale, variant)| {
            format!(
                "            \"{}\" => WorkingLocale::{},",
                locale.to_lowercase(),
                variant
            )
        })
        .collect();

    // Generate all() vector items
    let all_items: Vec<String> = locale_variants
        .iter()
        .map(|(_, variant)| format!("            WorkingLocale::{},", variant))
        .collect();

    let rust_code = format!(
        r#"//! Auto-generated locale enum from pipeline-manager config.yml
//! This file is generated by src/bin/generate-locale-enum.rs
//! Do not edit manually - regenerate using: just generate

/// Locale codes for working pipelines
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, serde::Serialize, serde::Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum WorkingLocale {{
{}
}}

impl WorkingLocale {{
    /// Get all working locales as a vector
    pub fn all() -> Vec<Self> {{
        vec![
{}
        ]
    }}
    
    /// Get the locale code as a string
    pub fn as_str(&self) -> &'static str {{
        match self {{
{}
        }}
    }}
    
    /// Get the locale code in lowercase
    pub fn as_lowercase(&self) -> &'static str {{
        match self {{
{}
        }}
    }}
}}

impl From<&str> for WorkingLocale {{
    fn from(s: &str) -> Self {{
        match s.to_lowercase().as_str() {{
{}
            _ => panic!("Invalid working locale: {{}}", s),
        }}
    }}
}}

impl std::fmt::Display for WorkingLocale {{
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {{
        write!(f, "{{}}", self.as_lowercase())
    }}
}}
"#,
        enum_variants.join("\n"),
        all_items.join("\n"),
        as_str_arms.join("\n"),
        as_lowercase_arms.join("\n"),
        from_str_arms.join("\n")
    );

    fs::write(output_path, rust_code)?;
    Ok(())
}

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Get paths relative to the binary location
    // manifest_dir is /Users/sartaj/Git/toolkit/actions/govbot
    // config is at /Users/sartaj/Git/toolkit/actions/pipeline-manager/config.yml
    let manifest_dir = PathBuf::from(env!("CARGO_MANIFEST_DIR"));
    let config_path = manifest_dir
        .parent()
        .unwrap() // /Users/sartaj/Git/toolkit/actions
        .join("pipeline-manager")
        .join("config.yml");
    let output_path = manifest_dir.join("src").join("locale_generated.rs");

    if !config_path.exists() {
        eprintln!(
            "‚ùå Error: Config file not found at {}",
            config_path.display()
        );
        std::process::exit(1);
    }

    let locales = get_working_locales(&config_path)?;
    if locales.is_empty() {
        eprintln!("‚ö†Ô∏è  Warning: No working locales found in config");
    }

    generate_rust_enum(&locales, &output_path)?;
    println!(
        "‚úÖ Generated {} with {} working locales",
        output_path.display(),
        locales.len()
    );
    println!("üìã Working locales: {}", locales.join(", "));

    Ok(())
}
