name: Test JSON Publisher

on:
  push:
    paths:
      - 'actions/json-publisher/**'
      - '.github/workflows/test-json-publisher.yml'
  pull_request:
    paths:
      - 'actions/json-publisher/**'
      - '.github/workflows/test-json-publisher.yml'
  workflow_dispatch:

jobs:
  test:
    name: Test JSON Publisher
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install validation tools
        run: sudo apt-get update && sudo apt-get install -y jq

      # Test 1: Run simple example
      - name: Simple report example
        run: |
          echo '{
            "test": "simple",
            "value": 123
          }' | python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/simple.html

          test -f /tmp/simple.html
          diff <(grep -v "Generated:" actions/json-publisher/examples/test_snapshots/simple.html) \
               <(grep -v "Generated:" /tmp/simple.html)

      # Test 2: Run complex example
      - name: Complex data report example
        run: |
          echo '{
            "string": "test",
            "number": 42,
            "float": 3.14,
            "boolean": true,
            "null_value": null,
            "array": [1, 2, 3],
            "nested": {
              "deep": "value"
            }
          }' | python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/complex.html

          test -f /tmp/complex.html
          diff <(grep -v "Generated:" actions/json-publisher/examples/test_snapshots/complex.html) \
               <(grep -v "Generated:" /tmp/complex.html)

      # Test 3: Run empty example
      - name: Empty report example
        run: |
          echo '{}' | python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/empty.html

          test -f /tmp/empty.html
          diff <(grep -v "Generated:" actions/json-publisher/examples/test_snapshots/empty.html) \
               <(grep -v "Generated:" /tmp/empty.html)

      # Test 4: Run test report example
      - name: Test report example
        run: |
          echo '{
            "timestamp": "2025-11-18T10:30:00Z",
            "project": "toolkit",
            "build": {
              "status": "success",
              "duration": 45.2,
              "commit": "abc123"
            },
            "tests": {
              "total": 127,
              "passed": 125,
              "failed": 2,
              "skipped": 0,
              "coverage": 94.5
            },
            "failures": [
              {
                "test": "authentication.test.js",
                "reason": "Expected 200 but got 401"
              },
              {
                "test": "database.test.js",
                "reason": "Connection timeout"
              }
            ]
          }' | python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/test-report.html

          test -f /tmp/test-report.html
          grep -q "toolkit" /tmp/test-report.html

      # Test 5: Git mode
      - name: Publish to git file
        run: |
          echo '{"mode": "git", "test": true}' | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/git-test.json

          test -f /tmp/git-test.json
          jq -e '.mode == "git"' /tmp/git-test.json

      # Test 6: Error handling - invalid JSON
      - name: Handle invalid JSON gracefully
        run: |
          if echo 'not json' | python3 actions/json-publisher/publish.py --mode git --output /tmp/fail.json 2>&1; then
            echo "ERROR: Should have failed with invalid JSON"
            exit 1
          fi

      # Test 7: Error handling - missing arguments
      - name: Validate required arguments
        run: |
          if echo '{}' | python3 actions/json-publisher/publish.py 2>&1; then
            echo "ERROR: Should have failed without --mode"
            exit 1
          fi

      # Test 8: Large file processing
      - name: Process large JSON file
        run: |
          python3 -c "import json; print(json.dumps({'items': [{'id': i} for i in range(1000)]}))" | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/large.json

          test -f /tmp/large.json
          test $(jq '.items | length' /tmp/large.json) -eq 1000

      # Test 9: Unicode and special characters
      - name: Handle Unicode and special characters
        run: |
          echo '{"unicode": "Hello ‰∏ñÁïå üåç", "special": "quotes \"test\" and symbols !@#$%"}' | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/unicode.html

          grep -q '‰∏ñÁïå' /tmp/unicode.html
          grep -q 'üåç' /tmp/unicode.html

      # Test 10: JSON output format validation
      - name: Validate JSON output format
        run: |
          echo '{"format": "test", "nested": {"value": 123}}' | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/formatted.json

          jq empty /tmp/formatted.json
          grep -q '^  "format"' /tmp/formatted.json

      # Test 11: HTML structure validation
      - name: Validate HTML structure
        run: |
          echo '{"validate": "html"}' | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/validate.html

          grep -q '<!DOCTYPE html>' /tmp/validate.html
          grep -q '<meta charset="UTF-8">' /tmp/validate.html
          grep -q '<meta name="viewport"' /tmp/validate.html
          grep -q 'toggleRaw()' /tmp/validate.html
          grep -q 'copyToClipboard()' /tmp/validate.html

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "JSON Publisher Tests Complete"
          echo "========================================="
          echo ""
          echo "‚úì All tests passed"
          echo ""
          echo "Tests covered:"
          echo "  - Example workflows (simple, complex, empty, test-report)"
          echo "  - Git and Pages publishing modes"
          echo "  - HTML generation with snapshot validation"
          echo "  - Error handling (invalid JSON, missing args)"
          echo "  - Edge cases (large files, Unicode, special chars)"
          echo "  - Output format validation (JSON/HTML structure)"
          echo "========================================="
