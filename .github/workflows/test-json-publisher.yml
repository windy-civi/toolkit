name: Test JSON Publisher

on:
  push:
    paths:
      - 'actions/json-publisher/**'
      - '.github/workflows/test-json-publisher.yml'
  pull_request:
    paths:
      - 'actions/json-publisher/**'
      - '.github/workflows/test-json-publisher.yml'
  workflow_dispatch:

jobs:
  test:
    name: Test JSON Publisher
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install validation tools
        run: sudo apt-get update && sudo apt-get install -y jq

      # Test 1: Basic stdin input
      - name: Publish test report to git file
        run: |
          echo '{"test": "stdin-git", "value": 123}' | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/test-git.json

          test -f /tmp/test-git.json
          jq -e '.test == "stdin-git"' /tmp/test-git.json

      # Test 2: File input
      - name: Publish from file to HTML
        run: |
          cat actions/json-publisher/examples/sample-report.json | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/report.html

          test -f /tmp/report.html
          test -f /tmp/report.json

      # Test 3: Complex JSON with all data types
      - name: Generate report with complex data
        run: |
          cat actions/json-publisher/examples/complex.json | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/complex-test.html

          # Compare against snapshot
          diff <(grep -v "Generated:" actions/json-publisher/examples/complex.html | grep -v "timestamp") \
               <(grep -v "Generated:" /tmp/complex-test.html | grep -v "timestamp")

      # Test 4: Error handling - invalid JSON
      - name: Handle invalid JSON gracefully
        run: |
          if echo 'not json' | python3 actions/json-publisher/publish.py --mode git --output /tmp/fail.json 2>&1; then
            echo "ERROR: Should have failed with invalid JSON"
            exit 1
          fi

      # Test 5: Error handling - missing arguments
      - name: Validate required arguments
        run: |
          if echo '{}' | python3 actions/json-publisher/publish.py 2>&1; then
            echo "ERROR: Should have failed without --mode"
            exit 1
          fi

      # Test 6: Edge case - empty object
      - name: Handle empty JSON object
        run: |
          echo '{}' | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/empty-test.html

          # Compare against snapshot
          diff <(grep -v "Generated:" actions/json-publisher/examples/empty.html | grep -v "timestamp") \
               <(grep -v "Generated:" /tmp/empty-test.html | grep -v "timestamp")

      # Test 7: Edge case - large file
      - name: Process large JSON file
        run: |
          python3 -c "import json; print(json.dumps({'items': [{'id': i} for i in range(1000)]}))" | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/large.json

          test -f /tmp/large.json
          test $(jq '.items | length' /tmp/large.json) -eq 1000

      # Test 8: Edge case - Unicode and special characters
      - name: Handle Unicode and special characters
        run: |
          echo '{"unicode": "Hello ä¸–ç•Œ ðŸŒ", "special": "quotes \"test\" and symbols !@#$%"}' | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/unicode.html

          grep -q 'ä¸–ç•Œ' /tmp/unicode.html
          grep -q 'ðŸŒ' /tmp/unicode.html

      # Test 9: Output format validation
      - name: Validate JSON output format
        run: |
          echo '{"format": "test", "nested": {"value": 123}}' | \
          python3 actions/json-publisher/publish.py \
            --mode git \
            --output /tmp/formatted.json

          # Validate JSON is well-formed
          jq empty /tmp/formatted.json

          # Verify 2-space indentation
          grep -q '^  "format"' /tmp/formatted.json

      # Test 10: HTML structure validation
      - name: Validate HTML structure
        run: |
          cat actions/json-publisher/examples/simple.json | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/simple-test.html

          # Validate HTML5 structure
          grep -q '<!DOCTYPE html>' /tmp/simple-test.html
          grep -q '<meta charset="UTF-8">' /tmp/simple-test.html
          grep -q '<meta name="viewport"' /tmp/simple-test.html

          # Validate interactive features
          grep -q 'toggleRaw()' /tmp/simple-test.html
          grep -q 'copyToClipboard()' /tmp/simple-test.html

      # Test 11: Snapshot comparison - simple
      - name: Snapshot test - simple JSON
        run: |
          cat actions/json-publisher/examples/simple.json | \
          python3 actions/json-publisher/publish.py \
            --mode pages \
            --output /tmp/simple-snapshot.html

          # Compare HTML output (excluding timestamp)
          diff <(grep -v "Generated:" actions/json-publisher/examples/simple.html | grep -v "timestamp") \
               <(grep -v "Generated:" /tmp/simple-snapshot.html | grep -v "timestamp")

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "========================================="
          echo "JSON Publisher Tests Complete"
          echo "========================================="
          echo ""
          echo "âœ“ All tests passed"
          echo ""
          echo "Tests covered:"
          echo "  - Stdin and file input"
          echo "  - Git and Pages publishing modes"
          echo "  - HTML generation with snapshot validation"
          echo "  - Error handling (invalid JSON, missing args)"
          echo "  - Edge cases (empty data, large files, Unicode)"
          echo "  - Output format validation (JSON/HTML structure)"
          echo "========================================="
